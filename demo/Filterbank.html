<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>Otonashi</title>
    <link rel="stylesheet" type="text/css" href="../style/style.css" charset="utf-8"/>
    <style>
canvas {
    display: block;
    margin: 0 auto;
}
table {
    border: none;
    border-collapse: collapse;
    border-spacing: 0px;
}
td, tr {
    padding: 1px;
}
    </style>
</head>
<body>
<div class="Main">
    <div class="Title">
        ğŸµ Otonashi å¯è§†åŒ–ï¼šåˆ†æå­å¸¦æ»¤æ³¢å™¨ç»„<span style="font-size: 13px; color: #aaa;">ï¼ˆéŸ³é¢‘æ•°æ®ä»…åœ¨æµè§ˆå™¨å†…éƒ¨å¤„ç†ï¼Œå¯æŸ¥çœ‹æœ¬é¡µä»£ç ä»¥äº†è§£å®ç°è¯¦æƒ…ã€‚ï¼‰</span>
    </div>

    <div class="Block" style="text-align: center;">
        <div style="text-align: left; line-height: 23px; color:#666;">
            â­ æœ¬é¡µæ¼”ç¤ºäº†MPEGéŸ³é¢‘ç¼–ç æ‰€ä½¿ç”¨çš„åˆ†æå­å¸¦æ»¤æ³¢å™¨ç»„ã€‚å»ºè®®ä½¿ç”¨ä»“åº“æä¾›çš„æ‰«é¢‘ç¤ºä¾‹ï¼ˆ<code>resource/Sweep.wav</code>ï¼‰æ¥æµ‹è¯•ï¼Œæ•ˆæœéå¸¸æ˜¾è‘—ã€‚æ ¹æ®æ ‡å‡†ï¼Œæ¯ä¸ªgranuleé•¿åº¦ä¸º576ç‚¹ï¼Œç»æ»¤æ³¢å™¨ç»„æ»¤æ³¢åï¼Œåˆ†ä¸º32ä¸ªå­å¸¦ï¼ˆä¹Ÿå°±æ˜¯ä¸‹é¢çš„32ä¸ªç¤ºæ³¢å™¨ï¼‰ï¼Œæ¯ä¸ªå­å¸¦æœ‰18ä¸ªæ—¶åŸŸé‡‡æ ·ï¼ˆç›¸å½“äº1/32é™é‡‡æ ·ï¼‰ã€‚
        </div>
        <div style="text-align: left; margin: 10px 0; padding: 10px; border-radius: 5px; background: #e1f5ff; font-weight: bold;">
            æ‰“å¼€éŸ³é¢‘æ–‡ä»¶ï¼ˆWAVã€MP3ç­‰å‡å¯ï¼‰ï¼š<input type="file" id="fileSelector" name="files[]" multiple>
        </div>

        <div style="margin: 10px 0;">
            <button id="play" data-state="stopped"><span id="playLabel">æ’­æ”¾</span><svg id="ThrobberPlaying" version="1" xmlns="http://www.w3.org/2000/svg" width="16" height="16" style="transform: scale(1); display: none; position: relative; top: 3px; left: 3px;"><style>@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(360deg)}}@keyframes fillunfill{0%{stroke-dashoffset:32.3}50%{stroke-dashoffset:0}to{stroke-dashoffset:-31.9}}@keyframes rot{0%{transform:rotate(0deg)}to{transform:rotate(-360deg)}}@keyframes colors{0%,to{stroke:#00aaff}}</style><g style="animation-duration:1568.63ms;animation-iteration-count:infinite;animation-name:rotate;animation-timing-function:linear;transform-origin:50% 50%;width:16px;height:16px"><path fill="none" d="M8 1.125A6.875 6.875 0 1 1 1.125 8" stroke-width="2.25" stroke-linecap="round" style="animation-duration:1333ms,5332ms,5332ms;animation-fill-mode:forwards;animation-iteration-count:infinite,infinite,infinite;animation-name:fillunfill,rot,colors;animation-play-state:running,running,running;animation-timing-function:cubic-bezier(.4,0,.2,1),steps(4),linear;transform-origin:50% 50%" stroke-dasharray="32.4" stroke-dashoffset="32.4"></path></g></svg></button>
        </div>
        <div class="ProcessbarContainer">
            <div id="progressbar" style="height: 100%; background-color: #00aaff; width: 5px;"></div>
            <div id="timer" style="position: absolute; top: 0; left: 0; font-size: 14px; height: 15px; line-height: 15px; margin: 5px 10px;"></div>
        </div>

        <table>
            <tr><td><canvas id="osc0"  height="100px" width="300px"></canvas></td><td><canvas id="osc1"  height="100px" width="300px"></canvas></td></tr>
            <tr><td><canvas id="osc2"  height="100px" width="300px"></canvas></td><td><canvas id="osc3"  height="100px" width="300px"></canvas></td></tr>
            <tr><td><canvas id="osc4"  height="100px" width="300px"></canvas></td><td><canvas id="osc5"  height="100px" width="300px"></canvas></td></tr>
            <tr><td><canvas id="osc6"  height="100px" width="300px"></canvas></td><td><canvas id="osc7"  height="100px" width="300px"></canvas></td></tr>
            <tr><td><canvas id="osc8"  height="100px" width="300px"></canvas></td><td><canvas id="osc9"  height="100px" width="300px"></canvas></td></tr>
            <tr><td><canvas id="osc10" height="100px" width="300px"></canvas></td><td><canvas id="osc11" height="100px" width="300px"></canvas></td></tr>
            <tr><td><canvas id="osc12" height="100px" width="300px"></canvas></td><td><canvas id="osc13" height="100px" width="300px"></canvas></td></tr>
            <tr><td><canvas id="osc14" height="100px" width="300px"></canvas></td><td><canvas id="osc15" height="100px" width="300px"></canvas></td></tr>
            <tr><td><canvas id="osc16" height="100px" width="300px"></canvas></td><td><canvas id="osc17" height="100px" width="300px"></canvas></td></tr>
            <tr><td><canvas id="osc18" height="100px" width="300px"></canvas></td><td><canvas id="osc19" height="100px" width="300px"></canvas></td></tr>
            <tr><td><canvas id="osc20" height="100px" width="300px"></canvas></td><td><canvas id="osc21" height="100px" width="300px"></canvas></td></tr>
            <tr><td><canvas id="osc22" height="100px" width="300px"></canvas></td><td><canvas id="osc23" height="100px" width="300px"></canvas></td></tr>
            <tr><td><canvas id="osc24" height="100px" width="300px"></canvas></td><td><canvas id="osc25" height="100px" width="300px"></canvas></td></tr>
            <tr><td><canvas id="osc26" height="100px" width="300px"></canvas></td><td><canvas id="osc27" height="100px" width="300px"></canvas></td></tr>
            <tr><td><canvas id="osc28" height="100px" width="300px"></canvas></td><td><canvas id="osc29" height="100px" width="300px"></canvas></td></tr>
            <tr><td><canvas id="osc30" height="100px" width="300px"></canvas></td><td><canvas id="osc31" height="100px" width="300px"></canvas></td></tr>
        </table>

    </div>



    <div style="text-align: center; font-size: 13px; color:#888888; margin: 20px auto; line-height: 20px;">
        <div><a href="https://github.com/mikukonai/Otonashi">Project Otonashi</a></div>
        <div>Copyright &copy; 2019.11.14 Mikukonai</div>
    </div>

</div>

<script src="../script/jquery.min.js"></script>
<script src="../script/canvas.js"></script>
<script src="../script/wav.js"></script>
<script src="../Constants.js"></script>
<script src="../Utils.js"></script>
<script src="../FFT.js"></script>
<script src="../AnalysisSubbandFilter.js"></script>

<script>

let Xmin = 0, Xmax = 17, Ymin = -1, Ymax = 1;
let cvs = new Array();
for(let i = 0; i < 32; i++) {
    let cv = new Canvas(`osc${String(i)}`, [Xmin, Ymin], [Xmax, Ymax]);
    cv.Init();
    cv.SetBackgroundColor("#000");
    cvs.push(cv);
}


const WINDOW_LENGTH = 1024;

// ç»˜åˆ¶æ³¢å½¢
function DrawFrame(cv, sbIndex, data) {
    cv.Init();
    cv.SetBackgroundColor("#000");
    // ç»˜åˆ¶æ¨ªåæ ‡
    for(let i = 0; i < data.length; i++) {
        cv.Line([i, cv.Ymin], [i, cv.Ymax], "#333");
        // cv.context.fillStyle = "#666";
        // cv.Text(`${i}`, [i, -0.9]);
    }
    // å­å¸¦ç¼–å·
    cv.context.fillStyle = "#fff";
    cv.Text(`Subband ${sbIndex}`, [0.5, 0.7]);
    for(let i = 1; i < data.length; i++) {
        cv.Line([i-1, data[i-1]], [i, data[i]], LineColor);
    }
}


let PCM;
let AudioContext = new window.AudioContext();
let filteredLeft, filteredRight;

let rawAudioData;

const LineColor = "#0f0";


let fileSelector = document.getElementById('fileSelector');
fileSelector.onchange = () => {
    let file = fileSelector.files[0];

    let Reader = new FileReader();

    Reader.onloadend = () => {
        rawAudioData = Reader.result;
    }

    Reader.readAsArrayBuffer(file);
};

function Render(rawAudioData, cutoffFreq) {
    AudioContext.decodeAudioData(rawAudioData, (audioBuffer) => {
        // è·å–ä¸¤ä¸ªå£°é“çš„åŸå§‹æ•°æ®
        let SampleRate = audioBuffer.sampleRate;
        let leftChannel  = audioBuffer.getChannelData(0);
        let rightChannel = audioBuffer.getChannelData(1);

        let AudioBufferSourceNode = AudioContext.createBufferSource();
        AudioBufferSourceNode.connect(AudioContext.destination);
        AudioBufferSourceNode.buffer = audioBuffer;
        AudioBufferSourceNode.start(0);

        let StartTime = AudioContext.currentTime;

        let timer = setInterval(() => {
            let offset = Math.round((AudioContext.currentTime - StartTime) * SampleRate);
            $("#timer").html(`${offset} / ${leftChannel.length} (${(offset / leftChannel.length * 100).toFixed(1)}%)`);
            $("#progressbar").css("width", `${(offset / leftChannel.length * 100).toFixed(2)}%`);

            // æ»¤æ³¢å™¨ç»„
            let subbands = AnalysisSubbandFilter(leftChannel, offset);

            // ç»˜åˆ¶
            for(let i = 0; i < 32; i++) {
                DrawFrame(cvs[i], i, subbands[i]);
            }

            if(offset >= leftChannel.length) {
                AudioBufferSourceNode.stop();
                clearInterval(timer);
                $("#playLabel").html("æ’­æ”¾");
                $("#ThrobberPlaying").hide();
                $("#play").attr("data-state", "stopped");
            }

        }, 10);
        });
}

$("#play").click(() => {
    let cutoff = parseFloat($("#cutoff").val());

    let state = $("#play").attr("data-state");
    if(state === "stopped") {
        $("#playLabel").html("æš‚åœ");
        $("#ThrobberPlaying").show();
        Render(rawAudioData, cutoff);
        $("#play").attr("data-state", "playing");
    }
    else if(state === "playing") {
        AudioContext.suspend();
        $("#playLabel").html("ç»§ç»­æ’­æ”¾");
        $("#ThrobberPlaying").hide();
        $("#play").attr("data-state", "pausing");
    }
    else if(state === "pausing") {
        AudioContext.resume();
        $("#playLabel").html("æš‚åœ");
        $("#ThrobberPlaying").show();
        $("#play").attr("data-state", "playing");
    }

    
});



</script>


</body>
</html>
